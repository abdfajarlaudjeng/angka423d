<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Data 2D dengan Filter & Validasi + Filter As</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-lg p-4">
    <h1 class="text-2xl font-bold mb-4">Data 2D - Google Sheets</h1>

    <!-- Input Filter & Angka Main -->
    <div class="mb-4 grid grid-cols-3 gap-4">
      <div>
        <label class="block font-semibold mb-1">Filter 2D</label>
        <input id="filter2D" type="text" maxlength="2" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring" placeholder="Misal: 16 atau 1">
      </div>

      <div>
        <label class="block font-semibold mb-1">Angka Main</label>
        <textarea id="angkaMain" rows="2" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring" placeholder="Pisahkan dengan spasi atau koma"></textarea>
      </div>

      <div>
        <label class="block font-semibold mb-1">Filter As</label>
        <select id="filterAs" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring">
          <option value="">Semua</option>
        </select>
      </div>
    </div>

    <!-- Tabel -->
    <div class="overflow-x-auto">
      <table class="min-w-full border border-gray-300 text-sm">
        <thead id="thead" class="bg-gray-200"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
    let data = [];
    const thead = document.getElementById("thead");
    const tbody = document.getElementById("tbody");
    const filterAsSelect = document.getElementById("filterAs");

    async function fetchData() {
      const url = "https://docs.google.com/spreadsheets/d/1tX6qfI_0PhrpmGxz4qqaT0_8YHKhPwE3dPHguPvNFmU/gviz/tq?tqx=out:json&sheet=DATA%202D";
      const res = await fetch(url);
      const text = await res.text();
      const json = JSON.parse(text.substr(47).slice(0, -2));

      data = json.table.rows.map(r => {
        let row = {};
        json.table.cols.forEach((c, i) => {
          if (c && c.label) row[c.label] = r.c[i] ? r.c[i].v : "";
        });
        return row;
      });

      const keys = Object.keys(data[0]);
      buildHeader(keys);
      buildAsFilterOptions();
      renderTable();
    }

    function buildHeader(keys) {
      thead.innerHTML = "";
      const tr = document.createElement("tr");

      keys.forEach(k => {
        const th = document.createElement("th");
        th.textContent = k;
        th.className = "px-3 py-2 text-left font-semibold border";
        tr.appendChild(th);
      });

      const thValidasi = document.createElement("th");
      thValidasi.textContent = "Validasi";
      thValidasi.className = "px-3 py-2 text-left font-semibold border";
      tr.appendChild(thValidasi);

      thead.appendChild(tr);
    }

    function buildAsFilterOptions() {
      const uniqueAs = [...new Set(data.map(r => r["As"]))].filter(a => a !== "");
      filterAsSelect.innerHTML = `<option value="">Semua</option>` +
        uniqueAs.map(as => `<option value="${as}">${as}</option>`).join("");
    }

    function renderTable() {
      const filter2D = document.getElementById("filter2D").value.trim();
      const angkaMainList = document.getElementById("angkaMain").value
        .split(/[\s,]+/)
        .map(s => s.trim())
        .filter(s => s !== "");
      const filterAs = filterAsSelect.value;

      const keys = Object.keys(data[0]);
      tbody.innerHTML = "";

      data.forEach(r => {
        const kepala = String(r["Kepala"] ?? "").padStart(2, "0");
        const ekor = String(r["Ekor"] ?? "").padStart(2, "0");

        // Filter berdasarkan AS
        if (filterAs && r["As"] != filterAs) return;

        // Filter berdasarkan input 2D
        if (filter2D) {
          if (filter2D.length === 1) {
            if (!(kepala.startsWith(filter2D) || ekor.endsWith(filter2D))) return;
          } else {
            if (kepala !== filter2D && ekor !== filter2D) return;
          }
        }

        const tr = document.createElement("tr");
        keys.forEach(k => {
          const td = document.createElement("td");
          td.textContent = r[k] ?? "";
          td.className = "px-3 py-2 border";

          // Highlight kolom Kepala/Ekor yang cocok
          if (filter2D) {
            if ((filter2D.length === 1 && ((k === "Kepala" && kepala.startsWith(filter2D)) || (k === "Ekor" && ekor.endsWith(filter2D)))) ||
                (filter2D.length === 2 && ((k === "Kepala" && kepala === filter2D) || (k === "Ekor" && ekor === filter2D)))) {
              td.classList.add("bg-yellow-200", "font-bold");
            }
          }

          tr.appendChild(td);
        });

        // Validasi angka main
        const tdValidasi = document.createElement("td");
        const angka2D = String(r["2D"] ?? "").padStart(2, "0");

        if (angkaMainList.length && angkaMainList.includes(angka2D)) {
          tr.classList.add("bg-green-100");
          tdValidasi.textContent = "✅ Cocok";
          tdValidasi.classList.add("text-green-600", "font-semibold", "px-3", "py-2", "border", "text-center");
        } else if (angkaMainList.length) {
          tr.classList.add("bg-red-100");
          tdValidasi.textContent = "❌ Tidak Cocok";
          tdValidasi.classList.add("text-red-600", "font-semibold", "px-3", "py-2", "border", "text-center");
        } else {
          tdValidasi.textContent = "-";
          tdValidasi.classList.add("px-3", "py-2", "border", "text-center");
        }

        tr.appendChild(tdValidasi);
        tbody.appendChild(tr);
      });
    }

    document.getElementById("filter2D").addEventListener("input", renderTable);
    document.getElementById("angkaMain").addEventListener("input", renderTable);
    filterAsSelect.addEventListener("change", renderTable);

    fetchData();
  </script>
</body>
</html>
