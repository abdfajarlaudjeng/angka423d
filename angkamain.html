<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Data 2D dengan Filter AS & Validasi</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-6xl mx-auto bg-white rounded-xl shadow-lg p-4">
    <h1 class="text-2xl font-bold mb-4">Data 2D - Google Sheets</h1>

    <!-- Filter -->
    <div class="mb-4 grid grid-cols-3 gap-4">
      <div>
        <label class="block font-semibold mb-1">Filter 2D</label>
        <input id="filter2D" type="text" maxlength="2" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring" placeholder="Misal: 16 atau 1">
      </div>
      <div>
        <label class="block font-semibold mb-1">Filter AS</label>
        <select id="filterAS" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring">
          <option value="">Semua</option>
          <option value="0">AS 0</option>
          <option value="1">AS 1</option>
          <option value="2">AS 2</option>
          <option value="3">AS 3</option>
          <option value="4">AS 4</option>
          <option value="5">AS 5</option>
          <option value="6">AS 6</option>
          <option value="7">AS 7</option>
          <option value="8">AS 8</option>
          <option value="9">AS 9</option>
        </select>
      </div>
      <div>
        <label class="block font-semibold mb-1">Angka Main</label>
        <textarea id="angkaMain" rows="1" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring" placeholder="Pisahkan dengan spasi atau koma"></textarea>
      </div>
    </div>

    <!-- Tabel -->
    <div class="overflow-x-auto">
      <table class="min-w-full border border-gray-300 text-sm">
        <thead id="thead" class="bg-gray-200"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <!-- Daftar angka 2D -->
    <div class="mt-4">
      <h2 class="text-lg font-semibold mb-2">Angka 2D Hasil Filter:</h2>
      <div id="list2D" class="p-2 border rounded bg-gray-50 text-sm leading-relaxed break-words"></div>
    </div>
  </div>

  <script>
    let data = [];
    const thead = document.getElementById("thead");
    const tbody = document.getElementById("tbody");
    const list2D = document.getElementById("list2D");

    async function fetchData() {
      const url = "https://docs.google.com/spreadsheets/d/1tX6qfI_0PhrpmGxz4qqaT0_8YHKhPwE3dPHguPvNFmU/gviz/tq?tqx=out:json&sheet=DATA%202D";
      const res = await fetch(url);
      const text = await res.text();
      const json = JSON.parse(text.substr(47).slice(0, -2));

      data = json.table.rows.map(r => {
        let row = {};
        json.table.cols.forEach((c, i) => {
          if (c && c.label) row[c.label] = r.c[i] ? r.c[i].v : "";
        });
        return row;
      });

      const keys = Object.keys(data[0]);
      buildHeader(keys);
      renderTable();
    }

    function buildHeader(keys) {
      thead.innerHTML = "";
      const tr = document.createElement("tr");

      keys.forEach(k => {
        const th = document.createElement("th");
        th.textContent = k;
        th.className = "px-3 py-2 text-left font-semibold border";
        tr.appendChild(th);
      });

      const thValidasi = document.createElement("th");
      thValidasi.textContent = "Validasi";
      thValidasi.className = "px-3 py-2 text-left font-semibold border";
      tr.appendChild(thValidasi);

      thead.appendChild(tr);
    }

    function renderTable() {
      const filter2D = document.getElementById("filter2D").value.trim();
      const filterAS = document.getElementById("filterAS").value.trim();
      const angkaMainList = document.getElementById("angkaMain").value
        .split(/[\s,]+/)
        .map(s => s.trim())
        .filter(s => s !== "");

      const keys = Object.keys(data[0]);
      tbody.innerHTML = "";
      let angka2DList = [];

      data.forEach(r => {
        const kepala = String(r["Kepala"] ?? "").padStart(2, "0");
        const ekor = String(r["Ekor"] ?? "").padStart(2, "0");
        const asVal = String(r["AS"] ?? "").trim();
        const angka2D = String(r["2D"] ?? "").padStart(2, "0");

        // Filter AS
        if (filterAS && asVal !== filterAS) return;

        // Filter 2D
        if (filter2D) {
          if (filter2D.length === 1) {
            if (!(kepala.startsWith(filter2D) || ekor.endsWith(filter2D))) return;
          } else {
            if (kepala !== filter2D && ekor !== filter2D) return;
          }
        }

        angka2DList.push(angka2D);

        const tr = document.createElement("tr");
        keys.forEach(k => {
          const td = document.createElement("td");
          td.textContent = r[k] ?? "";
          td.className = "px-3 py-2 border";

          // Highlight kepala/ekor sesuai filter
          if (filter2D) {
            if ((filter2D.length === 1 && ((k === "Kepala" && kepala.startsWith(filter2D)) || (k === "Ekor" && ekor.endsWith(filter2D)))) ||
                (filter2D.length === 2 && ((k === "Kepala" && kepala === filter2D) || (k === "Ekor" && ekor === filter2D)))) {
              td.classList.add("bg-yellow-200", "font-bold");
            }
          }
          tr.appendChild(td);
        });

        // Validasi Angka Main
        const tdValidasi = document.createElement("td");
        if (angkaMainList.length && angkaMainList.includes(angka2D)) {
          tr.classList.add("bg-green-100");
          tdValidasi.textContent = "✅ Cocok";
          tdValidasi.classList.add("text-green-600", "font-semibold", "px-3", "py-2", "border", "text-center");
        } else if (angkaMainList.length) {
          tr.classList.add("bg-red-100");
          tdValidasi.textContent = "❌ Tidak Cocok";
          tdValidasi.classList.add("text-red-600", "font-semibold", "px-3", "py-2", "border", "text-center");
        } else {
          tdValidasi.textContent = "-";
          tdValidasi.classList.add("px-3", "py-2", "border", "text-center");
        }
        tr.appendChild(tdValidasi);

        tbody.appendChild(tr);
      });

      // Tampilkan daftar angka 2D
      list2D.textContent = angka2DList.join(", ");
    }

    document.getElementById("filter2D").addEventListener("input", renderTable);
    document.getElementById("filterAS").addEventListener("change", renderTable);
    document.getElementById("angkaMain").addEventListener("input", renderTable);

    fetchData();
  </script>
</body>
</html>
